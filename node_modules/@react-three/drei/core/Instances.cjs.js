"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/extends"),t=require("three"),r=require("react"),n=require("@react-three/fiber"),a=require("react-composer"),c=require("../helpers/deprecated.cjs.js");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var i=s(e),u=o(t),l=o(r),f=s(a);const d=new u.Matrix4,m=new u.Matrix4,p=[],y=new u.Mesh;class x extends u.Group{constructor(){super(),this.color=new u.Color("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return null==(e=this.instance.current)?void 0:e.geometry}raycast(e,t){const r=this.instance.current;if(!r)return;if(!r.geometry||!r.material)return;y.geometry=r.geometry;const n=r.matrixWorld,a=r.userData.instances.indexOf(this.instanceKey);if(!(-1===a||a>r.count)){r.getMatrixAt(a,d),m.multiplyMatrices(n,d),y.matrixWorld=m,r.material instanceof u.Material?y.material.side=r.material.side:y.material.side=r.material[0].side,y.raycast(e,p);for(let e=0,r=p.length;e<r;e++){const r=p[e];r.instanceId=a,r.object=this,t.push(r)}p.length=0}}}const h=l.createContext(null),g=new u.Matrix4,M=new u.Matrix4,w=new u.Matrix4,b=new u.Vector3,v=new u.Quaternion,E=new u.Vector3,j=l.forwardRef((({context:e,children:t,...r},a)=>{l.useMemo((()=>n.extend({PositionMesh:x})),[]);const c=l.useRef();l.useImperativeHandle(a,(()=>c.current),[]);const{subscribe:s,getParent:o}=l.useContext(e||h);return l.useLayoutEffect((()=>s(c)),[]),l.createElement("positionMesh",i.default({instance:o(),instanceKey:c,ref:c},r),t)})),A=l.forwardRef((({context:e,children:t,range:r,limit:a=1e3,frames:s=1/0,...o},f)=>{const[{localContext:d,instance:m}]=l.useState((()=>{const e=l.createContext(null);return{localContext:e,instance:l.forwardRef(((t,r)=>l.createElement(j,i.default({context:e},t,{ref:r}))))}})),p=l.useRef(null);l.useImperativeHandle(f,(()=>p.current),[]);const[y,x]=l.useState([]),[[A,O]]=l.useState((()=>{const e=new Float32Array(16*a);for(let t=0;t<a;t++)w.identity().toArray(e,16*t);return[e,new Float32Array([...new Array(3*a)].map((()=>1)))]}));l.useEffect((()=>{p.current.instanceMatrix.needsUpdate=!0}));let C=0,R=0;n.useFrame((()=>{if(s===1/0||C<s){p.current.updateMatrix(),p.current.updateMatrixWorld(),g.copy(p.current.matrixWorld).invert(),R=Math.min(a,void 0!==r?r:a,y.length),p.current.count=R,c.setUpdateRange(p.current.instanceMatrix,{offset:0,count:16*R}),c.setUpdateRange(p.current.instanceColor,{offset:0,count:3*R});for(let e=0;e<y.length;e++){const t=y[e].current;t.matrixWorld.decompose(b,v,E),M.compose(b,v,E).premultiply(g),M.toArray(A,16*e),p.current.instanceMatrix.needsUpdate=!0,t.color.toArray(O,3*e),p.current.instanceColor.needsUpdate=!0}C++}}));const P=l.useMemo((()=>({getParent:()=>p,subscribe:e=>(x((t=>[...t,e])),()=>x((t=>t.filter((t=>t.current!==e.current)))))})),[]);return l.createElement("instancedMesh",i.default({userData:{instances:y},matrixAutoUpdate:!1,ref:p,args:[null,null,0],raycast:()=>null},o),l.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:A.length/16,array:A,itemSize:16,usage:u.DynamicDrawUsage}),l.createElement("instancedBufferAttribute",{attach:"instanceColor",count:O.length/3,array:O,itemSize:3,usage:u.DynamicDrawUsage}),"function"==typeof t?l.createElement(d.Provider,{value:P},t(m)):e?l.createElement(e.Provider,{value:P},t):l.createElement(h.Provider,{value:P},t))})),O=l.forwardRef((function({meshes:e,children:t,...r},n){const a=Array.isArray(e);if(!a)for(const t of Object.keys(e))e[t].isMesh||delete e[t];return l.createElement("group",{ref:n},l.createElement(f.default,{components:(a?e:Object.values(e)).map((({geometry:e,material:t})=>l.createElement(A,i.default({key:e.uuid,geometry:e,material:t},r))))},(r=>a?t(...r):t(Object.keys(e).filter((t=>e[t].isMesh)).reduce(((e,t,n)=>({...e,[t]:r[n]})),{})))))}));exports.Instance=j,exports.Instances=A,exports.Merged=O,exports.createInstances=function(){const e=l.createContext(null);return[l.forwardRef(((t,r)=>l.createElement(A,i.default({ref:r,context:e},t)))),l.forwardRef(((t,r)=>l.createElement(j,i.default({ref:r,context:e},t))))]};
